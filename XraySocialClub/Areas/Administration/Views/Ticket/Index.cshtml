@model IPagedList<Ticket>

<div class="container my-5">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb p-3 bg-body-tertiary rounded-3">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">Ticket Records</li>
        </ol>
    </nav>
</div>

<div class="px-4 py-5 my-5 text-center">
    <h1 class="display-5 fw-bold">Ticket Records</h1>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success" role="alert">
        @TempData["Success"]
    </div>
}
<a class="btn btn-primary mb-3" asp-action="Create">Create Ticket Record</a>

<div class="card p-4 shadow-lg mb-3">
    <table class="table table-striped table-bordered">
        <thead>
            <tr>
                <th scope="col">Draw Number</th>
                <th scope="col">Draw Date</th>
                <th scope="col">Price</th>
                <th scope="col">Notes</th>
                <th scope="col">Type</th>
                <th scope="col">Status</th>
                <th scope="col">Manage</th>
                <th scope="col">Update</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var m in Model)
            {
                <tr>
                    <td>@m.DrawNumber</td>
                    <td>@m.DrawDate</td>
                    <td>@m.Price</td>
                    <td>@m.Notes</td>
                    <td>@m.Type</td>
                    <td>@m.TicketStatus</td>
                    <td class="text-center">
                        <a href="@Url.Action("CreateRecord", "Ticket", new { id = m.Id })"
                            class="link-underline-primary">Add</a> | <a class="link-underline-primary"
                            style="cursor: pointer" onclick="viewTicketMembers(@m.Id)">View </a>
                    </td>
                    <td class="text-center">
                        @if (@m.TicketStatus != TicketStatus.Archived)
                        {
                            <a class="link-underline-primary" style="cursor: pointer"
                                onclick="confirmTicketArchive(@m.Id)">Archive
                            </a>
                        }
                        else if (@m.TicketStatus == TicketStatus.Archived)
                        {
                            <a class="link-underline-primary" style="cursor: pointer"
                                onclick="confirmTicketActivate(@m.Id)">Active
                            </a>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @Html.PagedListPager(Model, page => Url.Action("Index", new { page = page }),
    new PagedListRenderOptions
    {
        LiElementClasses = new string[] { "page-item" },
        PageClasses = new string[] { "page-link" }
    })

    <div class="mb-3">
        <a class="btn btn-primary float-end" asp-controller="Ticket" asp-action="Index"
            asp-route-isActive="true">Active</a>
        <a class="btn btn-primary float-end me-1" asp-controller="Ticket" asp-action="Index"
            asp-route-isActive="false">Archived</a>
        <a class="btn btn-primary float-end me-1" asp-controller="Ticket" asp-action="Index">All</a>
    </div>
    <div class="text-end">
        <p class="badge text-bg-secondary">Total Spent: @ViewBag.Total</p>
    </div>
</div>

<div class="modal" id="ticketMembersModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ticket Members</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBodyContent">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@* Confirmation on archiving a ticket *@
<div class="modal" id="confirmArchiveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Archive Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBodyContent">
                <p>Are you sure you want to archive this ticket?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-secondary" onclick="archiveTicket()">Yes</button>
            </div>
        </div>
    </div>
</div>

@* Confirmation on activating a ticket *@
<div class="modal" id="confirmActiveModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Archive Ticket</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBodyContent">
                <p>Are you sure you want to activate this ticket?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
                <button type="button" class="btn btn-secondary" onclick="activateTicket()">Yes</button>
            </div>
        </div>
    </div>
</div>

<script>
    var ticketId;

    function viewTicketMembers(id) {
        $.ajax({
            url: 'Ticket/ViewTicketMembers/' + id,
            type: 'GET',
            success: function (data) {
                $('#modalBodyContent').html(data);
                $('#ticketMembersModal').modal('show');
            },
            error: function () {
                alert('Failed to load ticket member details.');
            }
        });
    }

    function archiveTicket() {
        $.ajax({
            url: 'Ticket/ArchiveTicket/' + ticketId,
            type: 'POST',
            success: function (res) {
                if (res.redirectToUrl) {
                    window.location.href = res.redirectToUrl;
                }
                $('#confirmArchiveModal').modal('hide');
            },
            error: function () {
                alert("There was an error proccessing the ticket.");
            }
        });
    }

    function activateTicket() {
        $.ajax({
            url: 'Ticket/ActivateTicket/' + ticketId,
            type: 'POST',
            success: function (res) {
                if (res.redirectToUrl) {
                    window.location.href = res.redirectToUrl;
                }
                $('#confirmActiveModal').modal('hide');
            },
            error: function () {
                alert("There was an error proccessing the ticket.");
            }
        });
    }

    function confirmTicketArchive(id) {
        ticketId = id;
        $('#confirmArchiveModal').modal('show');
    }

    function confirmTicketActivate(id) {
        ticketId = id;
        $('#confirmActiveModal').modal('show');
    }
</script>